---
phase: 06-what-if-scenarios
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - frontend/src/pages/ScenarioPage.tsx
  - frontend/src/components/ScenarioBookingForm.tsx
  - frontend/src/components/ScenarioBookingList.tsx
  - frontend/src/components/ScenarioComparison.tsx
autonomous: false

must_haves:
  truths:
    - "User can add a hypothetical booking by selecting contract, resort, room, and dates"
    - "User can see all hypothetical bookings in a list with point costs and remove individual ones"
    - "User sees a side-by-side baseline vs scenario comparison table updating after each add/remove"
    - "User can clear all bookings to start fresh"
    - "Scenario page shows empty state when no contracts exist"
  artifacts:
    - path: "frontend/src/pages/ScenarioPage.tsx"
      provides: "Full scenario workspace page composing form + list + comparison"
      min_lines: 40
    - path: "frontend/src/components/ScenarioBookingForm.tsx"
      provides: "Add hypothetical booking form with cascading selectors"
      min_lines: 60
    - path: "frontend/src/components/ScenarioBookingList.tsx"
      provides: "List of hypothetical bookings with remove buttons"
      min_lines: 30
    - path: "frontend/src/components/ScenarioComparison.tsx"
      provides: "Baseline vs scenario comparison table with per-contract rows and totals"
      min_lines: 40
  key_links:
    - from: "frontend/src/components/ScenarioBookingForm.tsx"
      to: "frontend/src/store/useScenarioStore.ts"
      via: "addBooking action"
      pattern: "useScenarioStore.*addBooking"
    - from: "frontend/src/components/ScenarioBookingList.tsx"
      to: "frontend/src/store/useScenarioStore.ts"
      via: "removeBooking action"
      pattern: "useScenarioStore.*removeBooking"
    - from: "frontend/src/pages/ScenarioPage.tsx"
      to: "frontend/src/hooks/useScenarioEvaluation.ts"
      via: "evaluation hook with store bookings"
      pattern: "useScenarioEvaluation"
    - from: "frontend/src/components/ScenarioComparison.tsx"
      to: "frontend/src/types/index.ts"
      via: "ScenarioEvaluateResponse type"
      pattern: "ScenarioEvaluateResponse|ContractScenarioResult"
---

<objective>
Build the full scenario workspace UI: a form to add hypothetical bookings (with cascading contract/resort/room selectors), a list showing added bookings with costs and remove buttons, and a baseline-vs-scenario comparison table. This replaces the placeholder from Plan 02 with the complete experience.

Purpose: Delivers SCEN-01 (add multiple bookings), SCEN-02 (cumulative impact display), SCEN-03 (baseline vs scenario comparison), and SCEN-04 (clear/reset). This is the user-facing completion of Phase 6.

Output: ScenarioBookingForm.tsx, ScenarioBookingList.tsx, ScenarioComparison.tsx components, and updated ScenarioPage.tsx composing them all.
</objective>

<execution_context>
@.planning/phases/06-what-if-scenarios/06-RESEARCH.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-what-if-scenarios/06-01-SUMMARY.md
@.planning/phases/06-what-if-scenarios/06-02-SUMMARY.md
@frontend/src/types/index.ts
@frontend/src/store/useScenarioStore.ts
@frontend/src/hooks/useScenarioEvaluation.ts
@frontend/src/hooks/useContracts.ts
@frontend/src/hooks/usePointCharts.ts
@frontend/src/lib/api.ts
@frontend/src/components/Layout.tsx
@frontend/src/pages/ScenarioPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: ScenarioBookingForm + ScenarioBookingList components</name>
  <files>
    frontend/src/components/ScenarioBookingForm.tsx
    frontend/src/components/ScenarioBookingList.tsx
  </files>
  <action>
    Create `frontend/src/components/ScenarioBookingForm.tsx`:

    A form to add a hypothetical booking to the scenario. Uses cascading selectors:

    1. **Contract selector:** Use `useContracts()` to get all contracts. Display as `<Select>` with contract name or home resort as label, showing annual points. If no contracts exist, show nothing (parent handles empty state).

    2. **Resort selector:** When a contract is selected, compute eligible resorts using the contract's `eligible_resorts` array (already included in ContractWithDetails from useContracts). Use `useResorts()` to get resort display names. Display as `<Select>` showing resort name. When contract changes, RESET resort and room selection (cascading clear).

    3. **Room type selector:** When a resort is selected, fetch room types using `useChartRooms(selectedResort, currentYear)` from existing usePointCharts.ts. Display room keys in a `<Select>`. When resort changes, RESET room selection.

    4. **Check-in / Check-out date inputs:** Use native `<Input type="date" />`. Minimum check-in is today. Check-out must be after check-in, max 14 nights.

    5. **"Add to Scenario" button:** Disabled when form is incomplete (any field missing) or when booking count >= 10 (cap). On click, calls `useScenarioStore.getState().addBooking()` with the form data including contract_name and resort_name for display. Resets the form EXCEPT contract selection (likely adding multiple bookings for same contract).

    Use shadcn components: Card, CardHeader, CardTitle, CardContent, Button, Label, and native HTML select elements styled with Tailwind (matching existing form patterns in the app). Use the Plus icon from lucide-react for the add button.

    Create `frontend/src/components/ScenarioBookingList.tsx`:

    Displays the list of hypothetical bookings from the Zustand store, with resolved point costs from the evaluation response.

    1. Accept props: `bookings: HypotheticalBooking[]`, `resolvedBookings: ResolvedBooking[]` (from evaluation response, may be empty before first evaluation), `isEvaluating: boolean`.

    2. For each booking, render a card showing:
       - Resort name and room key (formatted)
       - Contract name
       - Check-in to check-out dates with night count (use date-fns format for display)
       - Point cost from resolvedBookings (match by contract_id + resort + room_key + check_in). Show "Calculating..." spinner while isEvaluating is true and no resolved cost yet.
       - A remove button (Trash2 icon) that calls `removeBooking(id)`

    3. Show booking count: "N of 10 bookings" with a visual indicator when approaching cap.

    4. Style with shadcn Card pattern. Each booking as a compact card within a vertical list. Use destructive variant for remove button.
  </action>
  <verify>
    Run `cd /Users/julianamacbook/DVC/frontend && npx tsc --noEmit` -- zero TypeScript errors.
  </verify>
  <done>
    ScenarioBookingForm renders cascading contract > resort > room > dates selectors with "Add to Scenario" button. ScenarioBookingList displays bookings with point costs and remove buttons. Both components compile without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: ScenarioComparison + full ScenarioPage composition</name>
  <files>
    frontend/src/components/ScenarioComparison.tsx
    frontend/src/pages/ScenarioPage.tsx
  </files>
  <action>
    Create `frontend/src/components/ScenarioComparison.tsx`:

    A table showing baseline vs scenario point balances per contract, plus grand totals.

    1. Accept props: `data: ScenarioEvaluateResponse | undefined`, `isLoading: boolean`.

    2. When data is undefined or loading, show a skeleton/placeholder state.

    3. When data exists, render a shadcn Table with columns:
       - Contract (name + home resort)
       - Baseline (available points)
       - Scenario (available points)
       - Impact (baseline - scenario, shown as negative number in red/destructive color)

    4. Footer row with TOTALS from data.summary: baseline_available, scenario_available, total_impact.

    5. Impact column: negative values in red (text-destructive), zero in muted. Show as "-N pts" format.

    6. If data.errors has entries, show an amber warning below the table listing each error (resort + room_key + error message).

    7. Use shadcn Table, TableHeader, TableBody, TableRow, TableHead, TableCell, TableFooter components.

    Replace the placeholder `frontend/src/pages/ScenarioPage.tsx` with the full composition:

    1. Use `useContracts()` to check if contracts exist. If no contracts, show empty state: "No contracts found. Add contracts first to model scenarios." with a link to /contracts.

    2. Read bookings from `useScenarioStore(state => state.bookings)` (selector pattern).
    3. Read clearAll from `useScenarioStore(state => state.clearAll)`.
    4. Call `useScenarioEvaluation(bookings)` to get evaluation data.

    5. Layout (matching research Pattern -- Scenario Page Layout):
       - Page header: "What-If Scenarios" with subtitle "Model hypothetical bookings and compare point impact"
       - A "Clear All" button (RotateCcw icon) in the header, disabled when bookings.length === 0, calls clearAll()
       - ScenarioBookingForm (always visible at top)
       - ScenarioBookingList (below form, shows added bookings). Pass bookings, evaluation.data?.resolved_bookings, evaluation.isLoading.
       - ScenarioComparison (below list, shows baseline vs scenario table). Only render when bookings.length > 0. Pass evaluation.data, evaluation.isLoading.
       - When bookings.length === 0, show a friendly empty state below the form: "Add hypothetical bookings above to see how they affect your point balances."

    6. Use FlaskConical icon from lucide-react in the page header for visual identity.
  </action>
  <verify>
    Run `cd /Users/julianamacbook/DVC/frontend && npx tsc --noEmit` -- zero TypeScript errors.
    Run `cd /Users/julianamacbook/DVC/frontend && npx vite build` -- production build succeeds.
  </verify>
  <done>
    Full scenario workspace renders: form adds bookings, list shows them with costs and remove, comparison table shows baseline vs scenario per contract with totals. Clear All resets everything. Empty states handled for no contracts and no bookings.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete What-If Scenario workspace: add hypothetical bookings with cascading selectors, see cumulative point impact in a baseline-vs-scenario comparison table, remove individual bookings or clear all.</what-built>
  <how-to-verify>
    1. Start the dev server: `cd /Users/julianamacbook/DVC && python -m uvicorn backend.main:app --reload` (backend) and `cd /Users/julianamacbook/DVC/frontend && npx vite --open` (frontend)
    2. Verify "Scenarios" appears in the sidebar navigation between Trip Explorer and Contracts
    3. Click "Scenarios" -- the page should load with a form and empty state message
    4. Add a hypothetical booking:
       a. Select a contract from the dropdown
       b. Select an eligible resort (list should filter by contract eligibility)
       c. Select a room type (should populate based on resort)
       d. Enter check-in and check-out dates
       e. Click "Add to Scenario"
    5. Verify the booking appears in the list with its point cost
    6. Verify the comparison table appears showing Baseline vs Scenario columns with the correct contract
    7. Add a second booking (same or different contract) and verify:
       a. Both bookings appear in the list
       b. Comparison table shows CUMULATIVE impact (not just the latest booking)
       c. Total row sums correctly
    8. Remove one booking using the trash icon -- verify the comparison updates
    9. Click "Clear All" -- verify all bookings removed and empty state returns
    10. If you have a resale contract, try adding a booking at an ineligible resort -- verify an error message appears
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the scenario workspace</resume-signal>
</task>

</tasks>

<verification>
- `cd /Users/julianamacbook/DVC/frontend && npx tsc --noEmit` -- zero errors
- `cd /Users/julianamacbook/DVC/frontend && npx vite build` -- production build succeeds
- `cd /Users/julianamacbook/DVC && python -m pytest tests/ -v --tb=short` -- full test suite passes
- Visual verification: scenario form works with cascading selectors, comparison table updates reactively
</verification>

<success_criteria>
- SCEN-01: User can add multiple hypothetical reservations via the form (contract > resort > room > dates cascade)
- SCEN-02: Comparison table shows cumulative point impact across all contracts with totals
- SCEN-03: Baseline (current reality) vs Scenario columns shown side-by-side per contract
- SCEN-04: "Clear All" button resets scenario; page refresh also clears (ephemeral Zustand state)
- Empty states: no-contracts state links to /contracts, no-bookings state shows helpful message
- Cap: form disables "Add" button at 10 bookings
</success_criteria>

<output>
After completion, create `.planning/phases/06-what-if-scenarios/06-03-SUMMARY.md`
</output>
