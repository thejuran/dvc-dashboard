---
phase: 08-code-hardening
plan: 04
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - tests/test_availability.py
  - tests/test_api_contracts.py
  - tests/test_api_reservations.py
  - tests/test_api_scenarios.py
  - tests/test_api_availability.py
  - tests/test_api_points.py
  - tests/test_booking_impact.py
  - tests/test_scenario.py
  - tests/test_edge_cases.py
  - tests/test_api_trip_explorer.py
autonomous: true

must_haves:
  truths:
    - "Tests pass for edge cases: 0 contracts, 0 points, expired use years, boundary dates"
    - "Integration tests verify key user flows: create contract, make reservation, check availability, what-if scenarios, booking impact preview"
    - "Edge case tests cover all items from success criteria: 0 contracts, 0 points, expired use years, boundary dates"
    - "All existing tests still pass after error format changes"
    - "Invalid inputs for all endpoints produce structured validation errors (tested)"
  artifacts:
    - path: "tests/test_edge_cases.py"
      provides: "Engine-level edge case tests for 0 contracts, 0 points, expired UY, boundary dates"
      min_lines: 100
    - path: "tests/test_api_trip_explorer.py"
      provides: "Trip explorer API integration tests"
      min_lines: 40
    - path: "tests/test_api_contracts.py"
      provides: "Updated contract tests verifying structured error format"
      contains: "error.*type"
    - path: "tests/test_api_scenarios.py"
      provides: "Scenario API tests including edge cases"
      contains: "hypothetical_bookings"
  key_links:
    - from: "tests/test_edge_cases.py"
      to: "backend/engine/availability.py"
      via: "pure function tests for edge cases"
      pattern: "get_contract_availability|get_all_contracts_availability"
    - from: "tests/test_api_*.py"
      to: "backend/api/errors.py"
      via: "assertions on structured error response format"
      pattern: 'error.*type.*VALIDATION_ERROR|NOT_FOUND'
---

<objective>
Expand test coverage to cover all edge cases and key user flows specified in the phase success criteria.

Purpose: Tests must prove the system handles 0 contracts, 0 points, expired use years, boundary dates, and all critical user flows (create contract, make reservation, check availability, what-if scenarios, booking impact preview). Also update existing tests that break due to the new structured error format.

Output: New test files for edge cases, expanded API integration tests, all tests green.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-code-hardening/08-CONTEXT.md
@.planning/phases/08-code-hardening/08-01-SUMMARY.md
@.planning/phases/08-code-hardening/08-02-SUMMARY.md

@backend/api/errors.py
@tests/conftest.py
@tests/test_api_contracts.py
@tests/test_api_reservations.py
@tests/test_api_scenarios.py
@tests/test_api_availability.py
@tests/test_api_points.py
@tests/test_availability.py
@tests/test_booking_impact.py
@tests/test_scenario.py
@backend/engine/availability.py
@backend/engine/booking_impact.py
@backend/engine/scenario.py
@backend/engine/trip_explorer.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update existing tests for structured error format and add validation tests</name>
  <files>tests/test_api_contracts.py, tests/test_api_reservations.py, tests/test_api_scenarios.py, tests/test_api_availability.py, tests/test_api_points.py, tests/test_api_point_charts.py, tests/test_api_booking_windows.py</files>
  <action>
After Plan 01+02, the error response format changed from `{"detail": "..."}` to `{"error": {"type": "...", "message": "...", "fields": [...]}}`. Update all existing API tests that assert on error responses.

**Pattern to apply across all API test files:**

Replace assertions like:
```python
assert resp.json()["detail"] == "Contract not found"
```
with:
```python
body = resp.json()
assert body["error"]["type"] == "NOT_FOUND"
assert "Contract not found" in body["error"]["message"]
```

**For each API test file, also ADD these new test cases:**

**test_api_contracts.py:**
- `test_create_contract_missing_required_fields`: POST with empty body -> 422, error type VALIDATION_ERROR, fields array has entries for home_resort, use_year_month, annual_points, purchase_type
- `test_create_contract_name_too_long`: name with 101+ chars -> 422
- `test_update_nonexistent_contract`: PUT /api/contracts/99999 -> 404
- `test_delete_nonexistent_contract`: DELETE /api/contracts/99999 -> 404

**test_api_reservations.py:**
- `test_create_reservation_ineligible_resort`: resale contract at polynesian, try to book riviera -> 422 with field "resort"
- `test_create_reservation_checkout_before_checkin`: -> 422 with field "check_out"
- `test_create_reservation_over_14_nights`: -> 422
- `test_preview_nonexistent_contract`: -> 404

**test_api_points.py:**
- `test_create_duplicate_point_balance`: same contract/year/type twice -> 409 CONFLICT
- `test_create_banked_exceeds_annual`: banked points > annual_points -> 422 with field "points"
- `test_update_nonexistent_balance`: PUT /api/points/99999 -> 404
- `test_delete_nonexistent_balance`: DELETE /api/points/99999 -> 404

**test_api_scenarios.py:**
- `test_evaluate_empty_scenario`: empty bookings list -> 200 with empty results
- `test_evaluate_nonexistent_contract`: booking with bad contract_id -> 422
- `test_evaluate_ineligible_resort`: booking with ineligible resort -> 422 with field detail
- `test_evaluate_over_10_bookings`: 11 bookings -> 422 (if implemented in Plan 02)

**test_api_availability.py:**
- `test_availability_no_contracts`: empty DB -> 200 with empty contracts list, summary all zeros
- `test_availability_missing_target_date`: no target_date query param -> 422

Add a new file **tests/test_api_trip_explorer.py:**
- `test_trip_explorer_valid_dates`: check_in=tomorrow, check_out=2 days after -> 200
- `test_trip_explorer_checkout_before_checkin`: -> 422 with field detail
- `test_trip_explorer_over_14_nights`: -> 422
- `test_trip_explorer_no_contracts`: empty DB -> 200 with empty options
- `test_trip_explorer_missing_dates`: missing query params -> 422

All new test assertions must verify:
1. Status code
2. `resp.json()["error"]["type"]` matches expected type
3. For validation errors: `resp.json()["error"]["fields"]` is a non-empty list (or check specific field names)
  </action>
  <verify>
Run `cd /Users/julianamacbook/DVC && python -m pytest tests/test_api_*.py -v` -- all API tests pass.

Count new tests: `grep -c "async def test_" tests/test_api_*.py` -- should be significantly more than the original count (~30+).
  </verify>
  <done>All existing API tests updated for structured error format. New validation and edge case tests added for every API endpoint. Tests verify error type, message, and field-level detail in structured responses.</done>
</task>

<task type="auto">
  <name>Task 2: Add engine-level edge case tests and flow integration tests</name>
  <files>tests/test_edge_cases.py, tests/test_availability.py, tests/test_booking_impact.py, tests/test_scenario.py</files>
  <action>
Create `tests/test_edge_cases.py` for engine-level edge cases that must be tested per success criteria:

**0 contracts / 0 points:**
- `test_availability_zero_contracts`: `get_all_contracts_availability(contracts=[], ...)` -> summary with all zeros
- `test_availability_zero_points`: contract exists but no point balances -> available_points = 0
- `test_scenario_zero_contracts`: `compute_scenario_impact(contracts=[], ...)` -> empty results
- `test_trip_explorer_zero_contracts`: `find_affordable_options(contracts=[], ...)` -> empty options
- `test_booking_impact_zero_points`: contract with no balances -> before.available_points = 0

**Expired use years:**
- `test_availability_expired_use_year`: target_date is well past the UY end (e.g., June 2023 UY, target date March 2026) -- should return 0 points for that UY
- `test_availability_only_old_balances`: all balances for UY 2022, target date 2026 -> available = 0

**Boundary dates:**
- `test_availability_uy_first_day`: target_date = exact first day of UY -> correct UY selected
- `test_availability_uy_last_day`: target_date = exact last day of UY -> correct UY selected
- `test_availability_uy_boundary_next_day`: target_date = one day after UY end -> next UY
- `test_reservation_check_in_on_uy_boundary`: reservation check_in on exact UY start and end dates
- `test_banking_deadline_exact_day`: target_date = exact banking deadline date

**In existing test files, add missing edge cases:**

**test_booking_impact.py:**
- `test_booking_impact_preview_full_flow`: create contract with balances, compute impact for a valid booking -> verify before/after snapshots
- `test_booking_impact_no_balances`: contract with 0 balances -> before.available = 0
- `test_booking_impact_all_points_committed`: all points used by reservations, new booking -> after.available = 0 or negative clamped to 0

**test_scenario.py:**
- `test_scenario_no_bookings`: evaluate with empty hypothetical list -> baseline == scenario
- `test_scenario_multiple_contracts`: two contracts, bookings spread across both
- `test_scenario_all_points_consumed`: scenario that uses all available points -> scenario_available = 0

All engine tests are pure-function tests (no DB, no async). Fast and reliable.
  </action>
  <verify>
Run `cd /Users/julianamacbook/DVC && python -m pytest tests/ -v` -- ALL tests pass (engine + API).

Run `cd /Users/julianamacbook/DVC && python -m pytest tests/test_edge_cases.py -v` -- all edge case tests pass.

Count total tests: `python -m pytest tests/ --co -q | tail -1` -- should show significant increase from baseline.
  </verify>
  <done>Edge case tests cover: 0 contracts, 0 points, expired use years, boundary dates. Integration tests cover: create contract, make reservation, check availability, what-if scenarios, booking impact preview. All tests pass.</done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -v` -- ALL tests pass (zero failures)
2. Edge cases tested: 0 contracts, 0 points, expired use years, boundary dates
3. Critical flows tested: create contract, make reservation, check availability, what-if scenarios, booking impact preview
4. Invalid inputs tested: all endpoints reject bad input with structured error responses
5. Structured error format verified in API tests: type, message, fields checked
</verification>

<success_criteria>
- All tests pass (zero failures, zero errors)
- Edge cases from success criteria 4 are all covered: 0 contracts, 0 points, expired use years, boundary dates
- Key user flows from QUAL-06 are all covered: create contract, make reservation, check availability, what-if scenarios, booking impact preview
- Invalid inputs for all endpoints are tested per SEC-02
- Test count increased significantly from baseline
</success_criteria>

<output>
After completion, create `.planning/phases/08-code-hardening/08-04-SUMMARY.md`
</output>
